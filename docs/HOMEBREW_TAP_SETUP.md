# Homebrew Tap Setup Guide

This document explains how to set up the Homebrew tap for Dark Storage CLI.

## Overview

A Homebrew "tap" is a third-party repository that contains formula files for installing packages.

- **Tap Repository**: `github.com/afterdarksys/homebrew-tap`
- **Formula Location**: `Formula/darkstorage.rb`
- **Install Command**: `brew install afterdarksys/tap/darkstorage`

---

## Setting Up the Tap Repository

### 1. Create the Repository

```bash
# Create new repository on GitHub
# Name: homebrew-tap
# Description: Homebrew tap for After Dark Systems packages
# Public repository
```

### 2. Clone and Initialize

```bash
git clone https://github.com/afterdarksys/homebrew-tap.git
cd homebrew-tap

# Create Formula directory
mkdir -p Formula

# Create README
cat > README.md <<EOF
# After Dark Systems Homebrew Tap

Homebrew tap for After Dark Systems packages.

## Usage

\`\`\`bash
brew tap afterdarksys/tap
brew install darkstorage
\`\`\`

Or install directly:

\`\`\`bash
brew install afterdarksys/tap/darkstorage
\`\`\`

## Available Packages

- **darkstorage** - Dark Storage CLI for secure cloud storage

## Support

- Documentation: https://docs.darkstorage.io
- Issues: https://github.com/afterdarksys/darkstorage-cli/issues
EOF

git add .
git commit -m "Initial commit: Homebrew tap"
git push origin main
```

### 3. Formula File (Auto-generated by GoReleaser)

GoReleaser will automatically create and update `Formula/darkstorage.rb` on each release.

Example formula (for reference):

```ruby
# This file is auto-generated by GoReleaser. Do not edit.
class Darkstorage < Formula
  desc "Dark Storage CLI - Secure, distributed cloud storage"
  homepage "https://darkstorage.io"
  version "0.2.0"
  license "MIT"

  on_macos do
    if Hardware::CPU.arm?
      url "https://github.com/afterdarksys/darkstorage-cli/releases/download/v0.2.0/darkstorage_0.2.0_darwin_arm64.tar.gz"
      sha256 "abc123..."
    end
    if Hardware::CPU.intel?
      url "https://github.com/afterdarksys/darkstorage-cli/releases/download/v0.2.0/darkstorage_0.2.0_darwin_amd64.tar.gz"
      sha256 "def456..."
    end
  end

  on_linux do
    if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
      url "https://github.com/afterdarksys/darkstorage-cli/releases/download/v0.2.0/darkstorage_0.2.0_linux_arm64.tar.gz"
      sha256 "ghi789..."
    end
    if Hardware::CPU.intel?
      url "https://github.com/afterdarksys/darkstorage-cli/releases/download/v0.2.0/darkstorage_0.2.0_linux_amd64.tar.gz"
      sha256 "jkl012..."
    end
  end

  def install
    bin.install "darkstorage"
  end

  test do
    system "#{bin}/darkstorage", "version"
  end
end
```

---

## GitHub Token Setup

For GoReleaser to automatically update the Homebrew tap, you need a GitHub token with `repo` permissions.

### Create Token

1. Go to https://github.com/settings/tokens/new
2. Name: `GoReleaser Homebrew Tap`
3. Expiration: No expiration (or long-term)
4. Scopes:
   - âœ… `repo` (Full control of private repositories)
5. Click "Generate token"
6. Copy the token (you won't see it again!)

### Add to Repository Secrets

1. Go to https://github.com/afterdarksys/darkstorage-cli/settings/secrets/actions
2. Click "New repository secret"
3. Name: `HOMEBREW_TAP_GITHUB_TOKEN`
4. Value: Paste your token
5. Click "Add secret"

---

## Testing the Tap

### Local Testing

```bash
# Tap the repository
brew tap afterdarksys/tap

# Install the package
brew install darkstorage

# Test it
darkstorage version

# Uninstall
brew uninstall darkstorage

# Untap
brew untap afterdarksys/tap
```

### Test Formula Locally

```bash
# Clone the tap
git clone https://github.com/afterdarksys/homebrew-tap.git
cd homebrew-tap

# Test the formula
brew install --build-from-source Formula/darkstorage.rb

# Audit the formula
brew audit --strict Formula/darkstorage.rb

# Test it
brew test darkstorage
```

---

## Releasing Updates

When you create a new GitHub release (via GoReleaser), it will:

1. Build binaries for all platforms
2. Upload to GitHub Releases
3. Calculate SHA256 checksums
4. Update the Homebrew formula
5. Commit and push to `homebrew-tap` repository

Users can then update with:

```bash
brew update
brew upgrade darkstorage
```

---

## Troubleshooting

### Formula Not Found

**Issue**: `Error: No available formula with the name "afterdarksys/tap/darkstorage"`

**Solution**:
```bash
brew update
brew tap afterdarksys/tap
```

### Checksum Mismatch

**Issue**: SHA256 mismatch when installing

**Solution**: GoReleaser will automatically fix this on next release. Or manually update:
```bash
cd $(brew --repository)/Library/Taps/afterdarksys/homebrew-tap
git pull
```

### Permission Denied

**Issue**: GoReleaser can't push to tap repository

**Solution**: Check that `HOMEBREW_TAP_GITHUB_TOKEN` has correct permissions:
- Verify token at https://github.com/settings/tokens
- Check repository secrets at repo settings
- Ensure token has `repo` scope

---

## Best Practices

### Formula Guidelines

- Keep formula simple (GoReleaser handles most of it)
- Include a meaningful description
- Add a test block to verify installation
- Follow Homebrew formula conventions

### Version Management

- Use semantic versioning (vX.Y.Z)
- Tag releases in git
- Let GoReleaser handle formula updates
- Don't manually edit formula files (they're auto-generated)

### Documentation

- Keep tap README updated
- Link to main project docs
- Document any special requirements
- Include usage examples

---

## Additional Taps (Future)

You can add more packages to the tap:

```bash
cd homebrew-tap/Formula

# Add more formula files
# darkstorage-gui.rb
# darkstorage-daemon.rb
# etc.
```

Each package needs:
- Its own formula file
- Separate release binaries
- Independent versioning
- Individual tests

---

## Resources

- [Homebrew Formula Cookbook](https://docs.brew.sh/Formula-Cookbook)
- [Creating Taps](https://docs.brew.sh/How-to-Create-and-Maintain-a-Tap)
- [GoReleaser Homebrew Documentation](https://goreleaser.com/customization/homebrew/)
- [Homebrew Formula API](https://rubydoc.brew.sh/Formula)

---

*Last Updated: 2026-02-24*
